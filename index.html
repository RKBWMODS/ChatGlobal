<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DF MODS CHAT GLOBAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Urbanist:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #128C7E;
            --primary-dark: #075E54;
            --secondary: #f0f2f5;
            --text: #050505;
            --text-light: #65676b;
            --white: #ffffff;
            --bg: #f0f2f5;
            --chat-bg: #e0f2e9;
            --border: #dddfe2;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --radius: 10px;
            --radius-lg: 12px;
            --radius-xl: 15px;
            --online: #31a24c;
            --danger: #e53935;
        }
        [data-theme="gradient"] {
            --primary: #128C7E;
            --primary-dark: #075E54;
            --secondary: linear-gradient(135deg, #f5f7fa, #e4e6eb);
            --text: #050505;
            --text-light: #65676b;
            --white: linear-gradient(135deg, #ffffff, #f0f2f5);
            --bg: linear-gradient(135deg, #f5f7fa, #e4e6eb);
            --chat-bg: linear-gradient(135deg, #e5efff, #d0e3ff);
            --border: #dddfe2;
            --online: #31a24c;
        }
        [data-theme="dark"] {
            --primary: #128C7E;
            --primary-dark: #075E54;
            --secondary: #181818;
            --text: #f5f5f5;
            --text-light: #bbbbbb;
            --white: #181818;
            --bg: #111111;
            --chat-bg: #23272a;
            --border: #222;
            --shadow: 0 2px 8px rgba(0,0,0,0.22);
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(7, 94, 84, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(7, 94, 84, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(7, 94, 84, 0); }
        }
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes messagePop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        html, body {
            width: 100vw;
            max-width: 100vw;
            height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            transition: all 0.2s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            height: 100vh;
            overflow: hidden;
        }
        .input-group {
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }
        .username-input, .start-chatting {
            box-sizing: border-box;
            width: 100%;
            display: block;
        }
        .username-input {
            padding: 12px;
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
            outline: none;
            background-color: #374151;
            color: #fff;
            font-size: 16px;
        }
        .start-chatting {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
            text-align: center;
        }
        .start-chatting:hover {
            background: linear-gradient(90deg, var(--primary-dark), #03433a);
            transform: scale(1.02);
        }
        .welcome-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            background: #111827;
            z-index: 1000;
            font-family: 'Urbanist', sans-serif;
            overflow: auto;
        }
        .welcome-content {
            background-color: #1f2937;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
            margin: 20px auto;
        }
        .welcome-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px auto;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            background-image: url('https://cdn-icons-png.flaticon.com/512/4712/4712109.png');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(59,130,246,0.5);
        }
        .welcome-logo i {
            font-size: 45px;
            color: white;
        }
        .welcome-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 34px;
            margin-bottom: 10px;
            color: #3b82f6;
            letter-spacing: 1px;
        }
        .welcome-text {
            font-size: 15px;
            color: #9ca3af;
            margin-bottom: 25px;
            max-width: 400px;
        }
        .app-container {
            display: flex;
            height: 100vw;
            max-width: 1400px;
            margin: 0 auto;
            box-shadow: var(--shadow);
            background: var(--white);
            position: relative;
        }
        .hidden {
            display: none !important;
        }
        .sidebar {
            width: 340px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 12px 16px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: var(--white);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            position: relative;
            background: var(--primary);
            transition: all 0.2s ease;
            font-size: 20px;
        }
        .avatar.online::after {
            content: '';
            width: 10px;
            height: 10px;
            background-color: var(--online);
            border-radius: 50%;
            border: 2px solid var(--white);
            position: absolute;
            bottom: 0;
            right: 0;
        }
        .user-info {
            display: flex;
            flex-direction: column;
        }
        .username {
            font-weight: 600;
            font-size: 15px;
        }
        .user-status {
            font-size: 12px;
            color: var(--text-light);
        }
        .chat-list {
            flex: 1;
            overflow-y: auto;
            background: var(--white);
        }
        .chat-item {
            display: flex;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: var(--white);
            align-items: center;
            gap: 12px;
        }
        .chat-item:hover {
            background: var(--secondary);
        }
        .chat-item.active {
            background: #e0f2e9;
        }
        .chat-avatar {
            position: relative;
        }
        .chat-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            justify-content: center;
        }
        .chat-name {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
        }
        .chat-preview {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
        }
        .chat-time {
            font-size: 12px;
            color: var(--text-light);
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
            min-width: 0;
            height: 100vh;
            max-height: 100vh;
            box-sizing: border-box;
            padding-bottom: 64px;
        }
        .chat-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .chat-title {
            flex: 1;
            margin-left: 12px;
        }
        .chat-name-lg {
            font-weight: 600;
            font-size: 16px;
        }
        .chat-status {
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-status .dot {
            width: 6px;
            height: 6px;
            background-color: var(--online);
            border-radius: 50%;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px;
        }

        .chat-action-btn:hover {
            color: var(--primary);
        }

        .chat-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            min-height: 0;
            padding-bottom: 8px;
            box-sizing: border-box;
        }

        .message {
            max-width: 85%;
            padding: 5px 10px;
            border-radius: var(--radius-xl);
            margin-bottom: 8px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease, messagePop 0.3s ease-out;
            line-height: 1.4;
            transition: all 0.2s ease;
            background: var(--chat-bg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px);}
            to { opacity: 1; transform: translateY(0);}
        }

        .message.sent {
            align-self: flex-end;
            background: var(--primary-dark);
            color: white;
            border-bottom-right-radius: var(--radius);
        }

        .message.received {
            align-self: flex-start;
            background: var(--white);
            border-bottom-left-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .message.selected {
            border: 2px solid var(--primary);
        }

        .message-info {
            display: flex;
            justify-content: flex-end;
            margin-top: 4px;
            font-size: 11px;
            color: inherit;
            opacity: 0.8;
            align-items: center;
            gap: 4px;
        }

        .message.sent .message-info {
            color: rgba(255,255,255,0.8);
        }

        .message.received .message-info {
            justify-content: flex-start;
            color: var(--text-light);
        }

        .message-header {
            position: absolute;
            top: -28px;
            right: 0;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px 15px 0 0;
            padding: 4px 10px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 2;
        }

        .message:hover .message-header,
        .message.selected .message-header {
            opacity: 1;
        }

        .reply-btn, .star-btn {
            background: black;
            border: none;
            font-size: 15px;
            cursor: pointer;
            padding: 4px;
            color: var(--primary-dark);
            border-radius: 20%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .reply-btn:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .star-btn {
            color: #fbc02d;
        }

        .star-btn:hover {
            background: #fffde7;
            color: #ffc107;
        }

        .reply-preview {
            background: var(--secondary);
            border-radius: 10px;
            padding: 6px 12px;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--text-light);
            border-left: 3px solid var(--primary);
            cursor: pointer;
            max-width: 90%;
            word-break: break-word;
        }

        .replying-bar {
            display: flex;
            align-items: center;
            background: var(--secondary);
            border-left: 3px solid var(--primary);
            border-radius: 10px 10px 10px 10px;
            margin-bottom: 6px;
            padding: 6px 12px;
            font-size: 13px;
            color: var(--text-light);
            position: relative;
            max-width: 90%;
        }

        .replying-bar .cancel-reply {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 13px;
            cursor: pointer;
            padding: 2px 8px;
        }

        .starred {
            background: #fffde7 !important;
        }

        .forwarded-label {
            font-size: 11px;
            color: #128c7e;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 5px 12px;
            background: none;
            display: flex;
            align-items: center;
            gap: 5px;
            height: auto;
            min-height: 56px;
        }

        .attach-btn {
            background: #011E36;
            border: none;
            border-radius: 50px;
            color: cyan;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px;
            width: 40px;
            height: 40px;
        }

        .location-btn {
            background: #011E36;;
            border: none;
            border-radius: 50px;
            color: cyan;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-btn:hover {
            color: var(--primary-dark);
            transform: scale(1.1);
        }

        .attach-btn:hover {
            color: var(--primary);
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
            margin-right: 10px;
        }

        .chat-input {
            width: 100%;
            padding: 6px 12px;
            border: 2px solid white;
            border-radius: 15px;
            background: #444;
            border-color: #666;
            outline: none;
            font-size: 15px;
            resize: none;
            min-height: 36px;
            max-height: 70px;
            overflow-y: auto;
            color: white;
            transition: all 0.2s ease;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .send-button {
            background: #011E36;
            color: cyan;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 19px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .send-button:hover {
            background: #011E36;
            transform: rotate(10deg) scale(1.1);
        }

        .send-button:active {
            animation: pulse 0.5s;
        }

        .send-button:disabled {
            background: #011E36;
            cursor: not-allowed;
            transform: none;
        }

        .send-button .spinner {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button .spinner::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .send-button .spinner::after {
            content: "";
            position: absolute;
            width: 70%;
            height: 70%;
            border: 3px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.5s linear infinite reverse;
        }

        .chat-media-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .chat-media-preview img, .chat-media-preview video {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }

        .chat-media-preview .remove-media {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--danger);
            cursor: pointer;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            opacity: 0;
            height: 0;
            transition: all 0.2s ease;
        }

        .typing-indicator.active {
            opacity: 1;
            height: auto;
        }

        .typing-bubble {
            display: flex;
            padding: 8px 12px;
            background: var(--white);
            border-radius: 18px;
            margin-left: 10px;
            box-shadow: var(--shadow);
            font-size: 12px;
            color: var(--text-light);
        }

        .typing-dots {
            display: flex;
            align-items: center;
            margin-left: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: var(--text-light);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0);}
            30% { transform: translateY(-4px);}
        }

        .day-divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: var(--text-light);
            font-size: 13px;
        }

        .day-divider::before, .day-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: cyan;
            margin: 0 10px;
        }

        .menu-container {
            position: absolute;
            top: 50px;
            right: 10px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            z-index: 100;
            transform: scale(0.9);
            opacity: 0;
            transform-origin: top right;
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .menu-container.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .menu-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: var(--secondary);
        }

        .menu-icon {
            font-size: 15px;
        }

        .unread-badge {
            background-color: var(--primary);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .mobile-menu-btn {
            display: none;
        }

        [data-theme="dark"] .chat-input-container {
            background: none;
        }

        [data-theme="dark"] .chat-input {
            background: #444;
            border-color: #666;
            font-size: 15px;
            min-height: 36px;
            padding: 6px 12px;
            max-height: 80px;
        }

        .restriction-info {
            background: #fff8e1;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            color: #5d4037;
            margin-top: 5px;
            border-left: 3px solid #ffc107;
        }

        .show-more-btn {
            color: green;
            cursor: pointer;
            font-weight: 500;
            display: inline-block;
            margin-top: 5px;
            transition: color 0.2s;
        }

        .show-more-btn:hover {
            color: green;
            text-decoration: underline;
        }

        .location-btn-display {
            display: inline-block;
            margin-top: 5px;
            padding: 8px 16px;
            background: #25d366;
            color: white;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            border: none;
        }
        
        .location-btn-display:hover {
            background: #128c7e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .location-container {
            margin-top: 8px;
        }

        .slim-location-btn {
            display: inline-block;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            border: none;
            outline: none;
            margin-top: 5px;
            transition: background 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .slim-location-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .slim-location-btn i {
            margin-right: 4px;
        }

        .char-counter {
            position: absolute;
            right: 10px;
            bottom: 5px;
            font-size: 12px;
            color: #666;
            background: rgba(255,255,255,0.7);
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 10;
        }

        .char-counter.warning {
            color: #ff5722;
        }

        .char-counter.error {
            color: #f44336;
            font-weight: bold;
        }

        .message-text {
            word-break: break-word;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(100%);
            opacity: 0;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .call-actions {
            display: flex;
            gap: 10px;
            margin-right: 10px;
        }
        
        .call-btn {
            background: #011E36;
            color: cyan;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .call-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }
        
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .call-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .call-container {
            background: #111;
            border-radius: 16px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .call-header {
            margin-bottom: 20px;
        }
        
        .call-title {
            font-size: 24px;
            color: white;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .call-status {
            color: #ddd;
            font-size: 16px;
        }
        
        .call-video-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .video-container {
            width: 200px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            background: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .video-container.local {
            border: 2px solid var(--primary);
        }
        
        .video-container.remote {
            border: 2px solid #25d366;
        }
        
        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            background: #222;
        }
        
        .video-placeholder i {
            font-size: 40px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .control-btn.primary {
            background: #25d366;
            color: white;
        }
        
        .control-btn.danger {
            background: #e53935;
            color: white;
        }
        
        .control-btn.default {
            background: #333;
            color: white;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .camera-preview {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 120px;
            height: 90px;
            border-radius: 8px;
            overflow: hidden;
            z-index: 200;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background: #000;
            display: none;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .close-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .call-options {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .option-btn {
            padding: 8px 15px;
            background: #333;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .option-btn:hover {
            background: #444;
        }
        
        .call-timer {
            font-size: 18px;
            color: white;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .camera-btn {
            background: #011E36;
            border: none;
            border-radius: 50px;
            color: cyan;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-btn:hover {
            color: var(--primary);
        }

        .minimized-call {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 4000;
            display: none;
            flex-direction: column;
        }
        
        .minimized-video-container {
            flex: 1;
            position: relative;
        }
        
        .minimized-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .minimized-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.5);
        }
        
        .minimized-controls .control-btn {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }
        
        .network-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 10;
        }
        
        .network-indicator.good {
            color: #4CAF50;
        }
        
        .network-indicator.average {
            color: #FFC107;
        }
        
        .network-indicator.poor {
            color: #F44336;
        }

        @media (min-width: 769px) {
            .chat-input-container {
                max-width: 1024px; /* input chat desktop */
                margin: 0 auto; /* Center the input container */
                left: unset;
                right: unset;
                width: 100%;
            }
        }

        @media (max-width: 992px) {
            .sidebar { width: 270px;}
        }

        @media (max-width: 768px) {
            .app-container { 
                flex-direction: column;
                height: 100vh;
                max-width: 100vw;
                min-width: 100vw;
                overflow-x: hidden;
            }
            .sidebar { 
                width: 100vw;
                height: 100vh;
                position: absolute;
                transform: translateX(-100%);
                z-index: 100;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .chat-container { 
                width: 100vw; 
                height: 100vh;
                max-height: 100vh;
                padding-bottom: 64px;
            }
            .chat-header {
                padding: 10px;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            .chat-content {
                padding: 10px;
                padding-bottom: 8px;
                max-height: calc(100vh - 56px - 50px);
                min-height: 0;
                box-sizing: border-box;
            }
            .message {
                max-width: 95%;
            }
            .chat-input-container {
                padding: 8px;
                height: auto;
                min-height: 56px;
            }
            .chat-input {
                padding: 6px 12px;
                font-size: 15px;
                min-height: 36px;
                max-height: 80px;
            }
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                color: var(--text-light);
                font-size: 20px;
                margin-right: 10px;
            }
            .message-header {
                top: -25px;
                padding: 3px 8px;
            }
            .reply-btn, .star-btn {
                font-size: 12px;
                width: 22px;
                height: 22px;
            }
            
            .welcome-content {
                padding: 30px;
            }
            .welcome-title {
                font-size: 28px;
            }
            .welcome-text {
                font-size: 13px;
            }
            
            .call-container {
                width: 95%;
                padding: 15px;
            }
            
            .video-container {
                width: 150px;
                height: 120px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .camera-preview {
                width: 100px;
                height: 75px;
                bottom: 70px;
                right: 15px;
            }
            
            .minimized-call {
                width: 150px;
                height: 120px;
            }
        }

        @media (max-width: 480px) {
            .welcome-content {
                padding: 20px;
            }
            .welcome-logo {
                width: 80px;
                height: 80px;
            }
            .welcome-logo i {
                font-size: 35px;
            }
            .welcome-title {
                font-size: 24px;
            }
            .welcome-text {
                font-size: 12px;
            }
            
            .call-title {
                font-size: 20px;
            }
            
            .video-container {
                width: 130px;
                height: 100px;
            }
            
            .call-video-container {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="welcome-container" id="welcomeScreen">
            <div class="welcome-content">
                <div class="welcome-logo">
                </div>
                <h1 class="welcome-title">DF CHAT</h1>
                <p class="welcome-text">Semua pesan tanpa pantauan silahkan menggunakan sesuka hati, Masih dalam pengembangan mohon di maklumi</p>
                
                <div class="input-group">
                    <input type="text" class="username-input" id="usernameInput" placeholder="Username" maxlength="12">
                    <button class="start-chatting" id="startChattingBtn">MASUK</button>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <span class="username" id="currentUsername">Username</span>
                        <span class="user-status" id="userStatus">Online</span>
                    </div>
                </div>
            </div>
            <div class="chat-list" id="chatList">
                <div class="chat-item active" id="globalChatItem">
                    <div class="chat-avatar">
                        <div class="avatar online" style="background-color: var(--primary);"><i class="fas fa-globe"></i></div>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">
                            <span>Global Chat DF</span>
                            <span class="chat-time" id="lastMessageTime">New</span>
                        </div>
                        <div class="chat-preview">Selamat datang di global community!</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="chat-avatar">
                    <div class="avatar online" style="background-color: var(--primary);"><i class="fas fa-globe"></i></div>
                </div>
                <div class="chat-title">
                    <div class="chat-name-lg">Global Chat DF</div>
                    <div class="chat-status">
                        <span class="dot"></span>
                        <span id="onlineUsersCount">0 online</span>
                    </div>
                </div>
                <div class="call-actions">
                    <button class="call-btn" id="voiceCallButton" title="Voice Call">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="call-btn" id="videoCallButton" title="Video Call">
                        <i class="fas fa-video"></i>
                    </button>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" id="menuButton"><i class="fas fa-bars"></i></button>
                </div>
            </div>
            <div class="chat-content" id="chatContent">
                <div class="day-divider">Hari Ini</div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-bubble">
                        <span id="typingText">Mengetik...</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-input-container hidden" id="chatInputContainer">
                <button class="attach-btn" id="attachButton"><i class="fas fa-paperclip"></i></button>
                <button class="camera-btn" id="cameraButton"><i class="fas fa-camera"></i></button>
                <button class="location-btn" id="locationButton"><i class="fas fa-map-marker-alt"></i></button>
                <div class="chat-input-wrapper">
                    <div id="replyingBar" style="display:none"></div>
                    <div id="mediaPreview" class="chat-media-preview" style="display:none"></div>
                    <textarea class="chat-input" id="messageInput" placeholder="Ketik Pesan" rows="1" maxlength="200"></textarea>
                    <div class="char-counter" id="charCounter">200</div>
                </div>
                <button class="send-button" id="sendButton" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div class="menu-container" id="menuContainer">
            <div class="menu-item" id="themeToggleMenuItem">
                <span class="menu-icon"><i class="fas fa-moon"></i></span>
                <span>Mode Gelap</span>
            </div>
            <div class="menu-item" id="clearChatButton">
                <span class="menu-icon"><i class="fas fa-trash"></i></span>
                <span>HAPUS PESAN</span>
            </div>
            <div class="menu-item" id="logoutButton">
                <span class="menu-icon"><i class="fas fa-sign-out-alt"></i></span>
                <span>LOGOUT AKUN</span>
            </div>
            <div class="menu-item" id="showStarredButton">
                <span class="menu-icon"><i class="fas fa-star"></i></span>
                <span>STAR CHATER</span>
            </div>
        </div>
        <div style="display:none" id="starredModal">
            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;">
                <div style="background:#fff;padding:24px 18px;max-width:350px;border-radius:14px;min-width:210px;box-shadow:0 6px 24px rgba(0,0,0,.16);position:relative;">
                    <button id="closeStarredModal" style="position:absolute;right:10px;top:10px;background:none;border:none;font-size:20px;cursor:pointer;color:#e53935;"><i class="fas fa-times"></i></button>
                    <div style="font-weight:600;font-size:18px;margin-bottom:12px;"><i class="fas fa-star"></i> Pesan Bintang</div>
                    <div id="starredList"></div>
                </div>
            </div>
        </div>
        <div class="notification" id="notification">
            <div class="notification-content">
                <span id="notificationMessage"></span>
                <button class="notification-close" id="notificationClose"><i class="fas fa-times"></i></button>
            </div>
        </div>
        
        <div class="call-modal" id="callModal">
            <div class="call-container">
                <div class="call-header">
                    <div class="call-title" id="callTitle">Panggilan Video</div>
                    <div class="call-status" id="callStatus">Memanggil...</div>
                    <div class="call-timer" id="callTimer">00:00</div>
                    <div class="network-indicator good" id="networkIndicator">
                        <i class="fas fa-signal"></i> Baik
                    </div>
                </div>
                
                <div class="call-video-container">
                    <div class="video-container local">
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoomInButton"><i class="fas fa-search-plus"></i></button>
                            <button class="zoom-btn" id="zoomOutButton"><i class="fas fa-search-minus"></i></button>
                        </div>
                        <div class="video-placeholder" id="localVideoPlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Kamera Anda</span>
                        </div>
                        <video id="localVideo" autoplay muted playsinline></video>
                    </div>
                    <div class="video-container remote">
                        <div class="video-placeholder" id="remoteVideoPlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Menunggu penerima</span>
                        </div>
                        <video id="remoteVideo" autoplay playsinline></video>
                    </div>
                </div>
                
                <div class="call-controls">
                    <button class="control-btn primary" id="answerCallButton">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="control-btn danger" id="endCallButton">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                    <button class="control-btn default" id="toggleVideoButton">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="control-btn default" id="toggleAudioButton">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-btn default" id="switchCameraButton">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="control-btn default" id="minimizeButton">
                        <i class="fas fa-window-minimize"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="minimized-call" id="minimizedCall">
            <div class="minimized-video-container">
                <video id="minimizedRemoteVideo" autoplay playsinline></video>
                <div class="minimized-controls">
                    <button class="control-btn maximize-btn" id="maximizeButton">
                        <i class="fas fa-window-maximize"></i>
                    </button>
                    <button class="control-btn danger end-call-btn" id="endCallButtonMinimized">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="camera-preview" id="cameraPreview">
            <button class="close-preview" id="closeCameraPreview">
                <i class="fas fa-times"></i>
            </button>
            <video id="cameraPreviewVideo" autoplay playsinline></video>
        </div>
    </div>
    <script type="module">
        document.documentElement.setAttribute('data-theme', 'dark');
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp, get, update, off, remove, query, limitToLast } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJ-cWGO4ViU4w1BE7CMGKD464aqHxMNZQ",
            authDomain: "chatglobal-1e541.firebaseapp.com",
            databaseURL: "https://chatglobal-1e541-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chatglobal-1e541",
            storageBucket: "chatglobal-1e541.firebasestorage.app",
            messagingSenderId: "72603231700",
            appId: "1:72603231700:web:1dcdd87b8ebffb4f7a6241",
            measurementId: "G-NGXHEVQD6Z"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const welcomeScreen = document.getElementById('welcomeScreen');
        const usernameInput = document.getElementById('usernameInput');
        const startChattingBtn = document.getElementById('startChattingBtn');
        const sidebar = document.getElementById('sidebar');
        const chatContainer = document.getElementById('chatContainer');
        const chatContent = document.getElementById('chatContent');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userAvatar = document.getElementById('userAvatar');
        const currentUsername = document.getElementById('currentUsername');
        const userStatus = document.getElementById('userStatus');
        const onlineUsersCount = document.getElementById('onlineUsersCount');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingText = document.getElementById('typingText');
        const lastMessageTime = document.getElementById('lastMessageTime');
        const globalChatItem = document.getElementById('globalChatItem');
        const menuButton = document.getElementById('menuButton');
        const menuContainer = document.getElementById('menuContainer');
        const clearChatButton = document.getElementById('clearChatButton');
        const logoutButton = document.getElementById('logoutButton');
        const attachButton = document.getElementById('attachButton');
        const locationButton = document.getElementById('locationButton');
        const replyingBar = document.getElementById('replyingBar');
        const showStarredButton = document.getElementById('showStarredButton');
        const starredModal = document.getElementById('starredModal');
        const starredList = document.getElementById('starredList');
        const closeStarredModal = document.getElementById('closeStarredModal');
        const chatInputContainer = document.getElementById('chatInputContainer');
        const mediaPreview = document.getElementById('mediaPreview');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationClose = document.getElementById('notificationClose');
        const charCounter = document.getElementById('charCounter');
        const cameraButton = document.getElementById('cameraButton');
        const voiceCallButton = document.getElementById('voiceCallButton');
        const videoCallButton = document.getElementById('videoCallButton');
        const themeToggleMenuItem = document.getElementById('themeToggleMenuItem');

        const callModal = document.getElementById('callModal');
        const callTitle = document.getElementById('callTitle');
        const callStatus = document.getElementById('callStatus');
        const callTimer = document.getElementById('callTimer');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideoPlaceholder = document.getElementById('localVideoPlaceholder');
        const remoteVideoPlaceholder = document.getElementById('remoteVideoPlaceholder');
        const answerCallButton = document.getElementById('answerCallButton');
        const endCallButton = document.getElementById('endCallButton');
        const toggleVideoButton = document.getElementById('toggleVideoButton');
        const toggleAudioButton = document.getElementById('toggleAudioButton');
        const switchCameraButton = document.getElementById('switchCameraButton');
        const minimizeButton = document.getElementById('minimizeButton');
        const zoomInButton = document.getElementById('zoomInButton');
        const zoomOutButton = document.getElementById('zoomOutButton');
        const networkIndicator = document.getElementById('networkIndicator');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraPreviewVideo = document.getElementById('cameraPreviewVideo');
        const closeCameraPreview = document.getElementById('closeCameraPreview');
        const minimizedCall = document.getElementById('minimizedCall');
        const minimizedRemoteVideo = document.getElementById('minimizedRemoteVideo');
        const maximizeButton = document.getElementById('maximizeButton');
        const endCallButtonMinimized = document.getElementById('endCallButtonMinimized');

        let mediaFile = null;
        let mediaUrl = null;
        let currentUser = null;
        let userId = null;
        let isTyping = false;
        let lastTypingTime = 0;
        let usersTyping = {};
        let onlineUsers = {};
        let lastMessageId = null;
        let messageListeners = [];
        let isScrolledUp = false;
        let lastScrollPosition = 0;
        let replyToMessage = null;
        let selectedMessages = [];
        let starredMessages = [];
        let shouldAutoScroll = true;
        let resizeObserver = null;
        let lastMessageTimestamp = 0;
        let firstLoad = true;
        
        let localStream = null;
        let remoteStream = null;
        let callActive = false;
        let callType = null;
        let callTimerInterval = null;
        let callStartTime = null;
        let videoEnabled = true;
        let audioEnabled = true;
        let cameraActive = false;
        let cameraStream = null;
        let currentZoom = 1;
        let videoDevices = [];
        let currentDeviceIndex = 0;
        let callMinimized = false;

        function initApp() {
            const savedUsername = localStorage.getItem('globalChatUsername');
            if (savedUsername) {
                usernameInput.value = savedUsername;
            }
            
            startChattingBtn.addEventListener('click', startChatting);
            sendButton.addEventListener('click', sendMessage);
            locationButton.addEventListener('click', shareLocation);
            
            messageInput.addEventListener('input', () => {
                updateSendButtonState();
                updateTypingStatus();
                autoResizeTextarea();
                updateCharCounter();
            });
            
            menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                menuContainer.classList.toggle('active');
            });
            
            document.addEventListener('click', () => {
                menuContainer.classList.remove('active');
            });
            
            clearChatButton.addEventListener('click', () => {
                if (confirm('Apakah kamu ingin menghapus chat?')) {
                    clearMyChat();
                    menuContainer.classList.remove('active');
                }
            });
            
            logoutButton.addEventListener('click', () => {
                if (confirm('Apakah kamu mau keluar dari akun ini?')) {
                    localStorage.removeItem('globalChatUsername');
                    window.location.reload();
                }
            });
            
            attachButton.addEventListener('click', openFileAttachment);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('focus', handleWindowFocus);
            chatContent.addEventListener('scroll', handleChatScroll);
            showStarredButton.addEventListener('click', showStarredModal);
            closeStarredModal.addEventListener('click', closeStarredModalFunc);
            window.addEventListener('resize', fixInputForKeyboard);
            notificationClose.addEventListener('click', () => {
                notification.classList.remove('show');
            });
            
            messageInput.addEventListener('focus', () => {
                fixInputForKeyboard();
                scrollToBottom(true);
            });
            
            messageInput.addEventListener('blur', restoreInputPosition);
            
            resizeObserver = new ResizeObserver(() => {
                if (shouldAutoScroll) {
                    scrollToBottom(true);
                }
            });
            resizeObserver.observe(chatContent);
            
            cameraButton.addEventListener('click', openCamera);
            voiceCallButton.addEventListener('click', () => startCall('voice'));
            videoCallButton.addEventListener('click', () => startCall('video'));
            answerCallButton.addEventListener('click', answerCall);
            endCallButton.addEventListener('click', endCall);
            toggleVideoButton.addEventListener('click', toggleVideo);
            toggleAudioButton.addEventListener('click', toggleAudio);
            switchCameraButton.addEventListener('click', switchCamera);
            minimizeButton.addEventListener('click', minimizeCall);
            maximizeButton.addEventListener('click', maximizeCall);
            endCallButtonMinimized.addEventListener('click', endCall);
            zoomInButton.addEventListener('click', () => adjustZoom(0.2));
            zoomOutButton.addEventListener('click', () => adjustZoom(-0.2));
            closeCameraPreview.addEventListener('click', closeCamera);
            
            themeToggleMenuItem.addEventListener('click', toggleTheme);
            updateThemeIcon();
            
            setInterval(updateNetworkQuality, 5000);
        }

        function updateThemeIcon() {
            const icon = themeToggleMenuItem.querySelector('.menu-icon i');
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                icon.className = 'fas fa-sun';
                themeToggleMenuItem.querySelector('span:last-child').textContent = 'Mode Terang';
            } else {
                icon.className = 'fas fa-moon';
                themeToggleMenuItem.querySelector('span:last-child').textContent = 'Mode Gelap';
            }
        }

        function toggleTheme() {
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                document.documentElement.setAttribute('data-theme', 'gradient');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            updateThemeIcon();
            menuContainer.classList.remove('active');
        }

        function updateCharCounter() {
            const maxLength = 200;
            const currentLength = messageInput.value.length;
            const remaining = maxLength - currentLength;
            
            charCounter.textContent = remaining;
            
            if (remaining <= 10) {
                charCounter.className = 'char-counter error';
            } else if (remaining <= 30) {
                charCounter.className = 'char-counter warning';
            } else {
                charCounter.className = 'char-counter';
            }
        }

        function showNotification(message) {
            notificationMessage.textContent = message;
            notification.classList.remove('hide');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
            }, 3000);
        }

        function shareLocation() {
            if (!navigator.geolocation) {
                alert("Browser Anda tidak mendukung fitur lokasi");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const mapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                    
                    const messagesRef = ref(database, 'messages');
                    const newMessageRef = push(messagesRef);
                    
                    set(newMessageRef, {
                        text: `Saya membagikan lokasi: ${mapsUrl}`,
                        username: currentUser.username,
                        userId: userId,
                        timestamp: Date.now(),
                        color: currentUser.color,
                        read: false,
                        location: { lat: latitude, lng: longitude }
                    });
                    
                    scrollToBottom(true);
                },
                (error) => {
                    console.error("Error getting location", error);
                    alert("Gagal mengambil lokasi: " + error.message);
                }
            );
        }

        function fixInputForKeyboard() {
            if (window.innerWidth <= 768 && document.activeElement === messageInput) {
                setTimeout(() => {
                    chatInputContainer.scrollIntoView({behavior: "smooth", block: "end"});
                    scrollToBottom(true);
                }, 200);
            }
        }

        function restoreInputPosition() {
            window.scrollTo({top: 0, behavior: "smooth"});
        }

        function startChatting() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('Mohon isi dengan benar');
                return;
            }
            
            userId = generateUserId();
            currentUser = {
                id: userId,
                username: username,
                color: getRandomColor(),
                online: true
            };
            
            localStorage.setItem('globalChatUsername', username);
            welcomeScreen.style.display = 'none';
            sidebar.style.display = 'flex';
            chatContainer.style.display = 'flex';
            currentUsername.textContent = username;
            userAvatar.textContent = '';
            userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            userAvatar.style.backgroundColor = currentUser.color;
            
            chatInputContainer.classList.remove('hidden');
            updateCharCounter();
            
            setupFirebase();
            setTimeout(() => { messageInput.focus(); }, 300);
        }

        function generateUserId() {
            return 'user_' + Date.now() + Math.random().toString(36).substr(2, 6);
        }

        function getRandomColor() {
            const colors = ['#25d366', '#128c7e', '#FF5722', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', '#FF9800'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function setupFirebase() {
            const messagesRef = ref(database, 'messages');
            const usersRef = ref(database, 'users');
            const typingRef = ref(database, 'typing');
            const userRef = ref(database, `users/${userId}`);
            
            messageListeners.forEach(off);
            messageListeners = [];
            
            const initialMessagesQuery = query(messagesRef, limitToLast(50));
            const messagesListener = onValue(initialMessagesQuery, (snapshot) => {
                const messages = snapshot.val();
                renderMessages(messages);
                if (firstLoad) {
                    scrollToBottom(true);
                    firstLoad = false;
                }
            });
            messageListeners.push(messagesListener);
            
            set(userRef, {
                username: currentUser.username,
                online: true,
                lastActive: serverTimestamp(),
                color: currentUser.color
            });
            
            onDisconnect(userRef).update({
                online: false,
                lastActive: serverTimestamp()
            });
            
            const usersListener = onValue(usersRef, (snapshot) => {
                const users = snapshot.val() || {};
                onlineUsers = users;
                let onlineCount = Object.values(users).filter(user => user.online).length;
                updateOnlineUsersCount(onlineCount);
            });
            messageListeners.push(usersListener);
            
            const typingListener = onValue(typingRef, (snapshot) => {
                const typingData = snapshot.val() || {};
                usersTyping = typingData;
                const otherUsersTyping = Object.entries(typingData)
                    .filter(([id, data]) => id !== userId && data.isTyping)
                    .map(([id, data]) => {
                        const user = onlineUsers[id] || { username: 'Unknown' };
                        return user.username;
                    });
                
                if (otherUsersTyping.length > 0) {
                    const names = otherUsersTyping.slice(0, 2).join(', ');
                    const moreCount = otherUsersTyping.length > 2 ? ` and ${otherUsersTyping.length - 2} more` : '';
                    typingText.textContent = `${names}${moreCount} typing`;
                    typingIndicator.classList.add('active');
                } else {
                    typingIndicator.classList.remove('active');
                }
            });
            messageListeners.push(typingListener);
            
            markMessagesAsRead();
        }

        function updateOnlineUsersCount(count) {
            onlineUsersCount.textContent = `${count} online`;
            userStatus.textContent = `${count} online`;
        }

        function renderMessages(messages) {
            if (!messages) return;
            
            const wasNearBottom = isNearBottom();
            
            if (firstLoad) {
                chatContent.innerHTML = '<div class="day-divider">Hari Ini</div>';
            }
            
            starredMessages = [];
            
            let sorted = Object.entries(messages).sort(([aId, a], [bId, b]) => (a.timestamp||0)-(b.timestamp||0));
            sorted.forEach(([id, message]) => {
                if (firstLoad || message.timestamp > lastMessageTimestamp) {
                    displayMessage(message, id);
                    if (message.starred) starredMessages.push({id, ...message});
                    lastMessageId = id;
                    lastMessageTimestamp = message.timestamp;
                }
            });
            
            updateLastMessageTime(messages);
            
            if (wasNearBottom || shouldAutoScroll) {
                scrollToBottom(true);
            }
        }

        function isNearBottom() {
            const threshold = 100;
            return chatContent.scrollHeight - (chatContent.scrollTop + chatContent.clientHeight) < threshold;
        }

        function displayMessage(message, id) {
            const isCurrentUser = message.userId === userId;
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            messageElement.dataset.messageId = id;
            messageElement.dataset.timestamp = message.timestamp || Date.now();
            
            if (selectedMessages.includes(id)) messageElement.classList.add('selected');
            if (message.starred) messageElement.classList.add('starred');
            
            let replyPreview = '';
            if (message.replyTo) {
                replyPreview = `<div class="reply-preview" onclick="window.scrollToReply('${message.replyTo.messageId}')"><b>${escapeHTML(message.replyTo.username)}</b>: ${escapeHTML(message.replyTo.text).slice(0, 60)}</div>`;
            }
            
            let mediaContent = '';
            if (message.media && message.mediaType) {
                if (message.mediaType.startsWith("image/")) {
                    mediaContent = `<img src="${message.media}" alt="image" style="max-width:160px;max-height:160px;border-radius:8px;margin-bottom:6px;" />`;
                } else {
                    mediaContent = `<a href="${message.media}" target="_blank" style="color:#25d366;font-size:14px;margin-bottom:6px;display:inline-block;"><i class="fas fa-file"></i> File</a>`;
                }
            }
            
            let locationContent = '';
            let displayText = escapeHTML(message.text);
            
            if (message.text) {
                let url = null;
                if (message.text.includes('Saya membagikan lokasi:')) {
                    url = message.text.split('Saya membagikan lokasi:')[1].trim();
                } else if (message.text.includes('Membagikan Lokasi:')) {
                    url = message.text.split('Membagikan Lokasi:')[1].trim();
                }

                if (url) {
                    locationContent = `
                        <button class="slim-location-btn" onclick="window.open('${escapeHTML(url)}', '_blank')">
                            <i class="fas fa-map-marker-alt"></i> Lihat Lokasi
                        </button>
                    `;
                    displayText = '';
                }
            }
            
            let showMoreBtn = '';
            if (displayText.length > 100) {
                const shortText = displayText.substring(0, 100);
                displayText = `
                    <span class="message-text" data-full="${displayText}">${shortText}</span>
                    <br><span class="show-more-btn" onclick="window.toggleMessageExpand(this)">Baca selengkapnya...</span></br>
                `;
            } else {
                displayText = displayText ? `<span class="message-text">${displayText}</span>` : '';
            }
            
            const time = formatTime(message.timestamp);
            const statusIcon = isCurrentUser ? getStatusIcon(message.read) : '';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <button class="reply-btn" title="Reply"><i class="fas fa-reply"></i></button>
                    <button class="star-btn" title="Star">${message.starred ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>'}</button>
                </div>
                
                ${replyPreview}
                ${mediaContent}
                ${displayText ? `<div>${displayText}</div>` : ''}
                ${locationContent}
                <div class="message-info">
                    ${!isCurrentUser ? `<span><i class="fas fa-user"></i> ${escapeHTML(message.username)}</span>` : ''}
                    <span class="message-time"><i class="fas fa-clock"></i> ${time}</span>
                    ${statusIcon}
                </div>
            `;
            
            messageElement.querySelector('.reply-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                startReplyToMessage(message, id);
            });
            
            messageElement.querySelector('.star-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                starMessage(id, !message.starred);
            });
            
            messageElement.addEventListener('click', () => {
                if (selectedMessages.includes(id)) {
                    selectedMessages = selectedMessages.filter(x => x !== id);
                } else {
                    selectedMessages.push(id);
                }
            });
            
            chatContent.appendChild(messageElement);
        }
        
        window.toggleMessageExpand = function(btn) {
            const messageElement = btn.closest('.message');
            const messageTextSpan = messageElement.querySelector('.message-text');
            const fullText = messageTextSpan.dataset.full;
            
            if (btn.textContent === 'Baca selengkapnya') {
                messageTextSpan.textContent = fullText;
                btn.textContent = 'Lihat lebih sedikit';
            } else {
                messageTextSpan.textContent = fullText.substring(0, 100) + '...';
                btn.textContent = 'Baca selengkapnya';
            }
        };
        
        function startReplyToMessage(message, id) {
            replyToMessage = { messageId: id, username: message.username, text: message.text };
            renderReplyBar();
            messageInput.focus();
        }
        
        function renderReplyBar() {
            if (replyToMessage) {
                replyingBar.innerHTML = `<span><b>${escapeHTML(replyToMessage.username)}</b>: ${escapeHTML(replyToMessage.text).slice(0,60)}</span>
                <button class="cancel-reply" id="cancelReplyBtn" title="Cancel"><i class="fas fa-times"></i></button>`;
                replyingBar.style.display = 'flex';
                document.getElementById('cancelReplyBtn').onclick = cancelReply;
            } else {
                replyingBar.style.display = 'none';
            }
        }
        
        function cancelReply() {
            replyToMessage = null;
            renderReplyBar();
        }
        
        function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (messageText.length > 200) {
                showNotification("Pesan tidak boleh lebih dari 200 karakter!");
                return;
            }
            
            if (!messageText && !mediaFile) return;
            
            sendButton.innerHTML = '<div class="spinner"></div>';
            sendButton.disabled = true;
            
            const messagesRef = ref(database, 'messages');
            const newMessageRef = push(messagesRef);
            
            let data = {
                text: messageText,
                username: currentUser.username,
                userId: userId,
                timestamp: Date.now(),
                color: currentUser.color,
                read: false
            };
            
            if (replyToMessage) data.replyTo = replyToMessage;
            
            if (mediaFile && mediaUrl) {
                data.media = mediaUrl;
                data.mediaType = mediaFile.type;
            }
            set(newMessageRef, data);
            setTimeout(() => {
                messageInput.value = '';
                isTyping = false;
                updateTypingStatusInFirebase();
                updateSendButtonState();
                resetTextareaHeight();
                cancelReply();
                clearMediaPreview();
                shouldAutoScroll = true;
                scrollToBottom(true);
                updateCharCounter();
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendButton.disabled = false;
            }, 500);
        }
        function starMessage(id, starred) {
            const msgRef = ref(database, 'messages/' + id + '/starred');
            set(msgRef, starred);
        }
        window.scrollToReply = function(messageId) {
            const el = chatContent.querySelector(`[data-message-id='${messageId}']`);
            if (el) {
                el.scrollIntoView({behavior:'smooth', block:'center'});
                el.style.background = "rgba(37,211,102,0.13)";
                setTimeout(()=>{el.style.background="";}, 900);
            }
        }
        function escapeHTML(str) {
            return (str+"").replace(/[<>&"]/g,function(c){
                return {'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c];
            });
        }
        function formatTime(timestamp) {
            if (!timestamp) return 'Baru';
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) return 'Baru saja';
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            if (diffInMinutes < 1) return 'Baru saja';
            if (diffInMinutes < 60) return `${diffInMinutes} Min`;
            if (diffInMinutes < 24 * 60) return `${Math.floor(diffInMinutes / 60)} Jam`;
            return date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' });
        }
        function getStatusIcon(read) {
            if (read) {
                return '<span class="message-status read"><i class="fas fa-check-double"></i></span>';
            } else {
                return '<span class="message-status"><i class="fas fa-check-double"></i></span>';
            }
        }
        function updateLastMessageTime(messages) {
            if (!messages) return;
            let lastMessage = null;
            Object.values(messages).forEach((msg) => {
                if (!lastMessage || (msg.timestamp || 0) > (lastMessage.timestamp || 0)) lastMessage = msg;
            });
            if (!lastMessage) return;
            lastMessageTime.textContent = formatTime(lastMessage.timestamp);
            const chatPreview = document.querySelector('.chat-item.active .chat-preview');
            if (chatPreview && lastMessage.text) {
                const previewText = lastMessage.text.length > 30 
                    ? lastMessage.text.substring(0, 30) + '...' 
                    : lastMessage.text;
                chatPreview.textContent = previewText;
            }
        }
        function updateTypingStatus() {
            if (!currentUser) return;
            const now = Date.now();
            const typingTimeout = 2000;
            if (messageInput.value.length > 0) {
                isTyping = true;
                lastTypingTime = now;
                updateTypingStatusInFirebase();
            } else {
                isTyping = false;
                updateTypingStatusInFirebase();
            }
            setTimeout(() => {
                if (now - lastTypingTime >= typingTimeout && isTyping) {
                    isTyping = false;
                    updateTypingStatusInFirebase();
                }
            }, typingTimeout);
        }
        function updateTypingStatusInFirebase() {
            if (!currentUser) return;
            const typingRef = ref(database, `typing/${userId}`);
            if (isTyping) {
                set(typingRef, {
                    isTyping: true,
                    username: currentUser.username,
                    timestamp: serverTimestamp()
                });
            } else {
                set(typingRef, {
                    isTyping: false,
                    username: currentUser.username,
                    timestamp: serverTimestamp()
                });
            }
        }
        function markMessagesAsRead() {
            if (!lastMessageId) return;
            const messagesRef = ref(database, 'messages');
            get(messagesRef).then((snapshot) => {
                const messages = snapshot.val();
                if (!messages) return;
                const updates = {};
                Object.entries(messages).forEach(([id, message]) => {
                    if (message.userId !== userId && !message.read) {
                        updates[`${id}/read`] = true;
                    }
                });
                if (Object.keys(updates).length > 0) {
                    update(messagesRef, updates);
                }
            });
        }
        function handleVisibilityChange() {
            if (document.visibilityState === 'visible') {
                document.title = 'DF MODS';
                markMessagesAsRead();
            }
        }
        function handleWindowFocus() {
            markMessagesAsRead();
        }
        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        }
        function resetTextareaHeight() {
            messageInput.style.height = 'auto';
        }
        function updateSendButtonState() {
            sendButton.disabled = messageInput.value.trim() === '' && !mediaFile;
        }
        function scrollToBottom(force = false) {
            if (force || shouldAutoScroll) {
                setTimeout(() => {
                    chatContent.scrollTo({
                        top: chatContent.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
        function handleChatScroll() {
            const threshold = 100;
            const position = chatContent.scrollTop + chatContent.clientHeight;
            const isNearBottom = position > chatContent.scrollHeight - threshold;
            shouldAutoScroll = isNearBottom;
            if (!isNearBottom && chatContent.scrollTop < lastScrollPosition) {
                shouldAutoScroll = false;
            }
            lastScrollPosition = chatContent.scrollTop;
        }
        function openFileAttachment() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = "image/*,.pdf,.doc,.docx,.ppt,.pptx,.zip,.rar,.txt";
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (file.type.startsWith("video/") || file.type.startsWith("audio/")) {
                    alert("Video & Audio Dilarang!");
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert("Hanya Boleh 5 MB");
                    return;
                }
                showMediaPreview(file);
            };
            input.click();
        }
        function showMediaPreview(file) {
            mediaFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                mediaUrl = e.target.result;
                let preview = '';
                if (file.type.startsWith("image/")) {
                    preview = `<img src="${mediaUrl}" style="max-width:80px;max-height:80px;border-radius:8px;" alt="preview"/>`;
                } else {
                    preview = `<span style="color:#25d366;font-size:14px;"><i class="fas fa-file"></i> ${file.name}</span>`;
                }
                preview += `<button class="remove-media" id="removeMediaBtn" title="Remove"><i class="fas fa-times"></i></button>`;
                mediaPreview.innerHTML = preview;
                mediaPreview.style.display = "flex";
                const restrictionInfo = document.createElement('div');
                restrictionInfo.className = 'restriction-info';
                restrictionInfo.innerHTML = '<i class="fas fa-info-circle"></i> Video & Audio Dilarang!';
                mediaPreview.appendChild(restrictionInfo);
                document.getElementById("removeMediaBtn").onclick = clearMediaPreview;
                updateSendButtonState();
            };
            reader.readAsDataURL(file);
        }
        function clearMediaPreview() {
            mediaFile = null;
            mediaUrl = null;
            mediaPreview.innerHTML = "";
            mediaPreview.style.display = "none";
            updateSendButtonState();
        }
        function clearMyChat() {
            const messagesRef = ref(database, 'messages');
            get(messagesRef).then((snapshot) => {
                const messages = snapshot.val();
                if (!messages) return;
                Object.entries(messages).forEach(([id, message]) => {
                    if (message.userId === userId) {
                        remove(ref(database, 'messages/' + id));
                    }
                });
                alert('Berhasil Menghapus Pesan');
            });
        }
        function showStarredModal() {
            starredModal.style.display = '';
            starredList.innerHTML = '';
            if (!starredMessages.length) {
                starredList.innerHTML = '<div style="color:#888;font-size:14px;"><i class="far fa-star"></i> Tidak memiliki pesan</div>';
                return;
            }
            starredMessages.forEach(msg => {
                let div = document.createElement('div');
                div.style.marginBottom = "12px";
                div.style.padding = "8px";
                div.style.background = "#fffde7";
                div.style.borderRadius = "7px";
                div.innerHTML = `<b><i class="fas fa-user"></i> ${escapeHTML(msg.username)}</b><br>${escapeHTML(msg.text)}`;
                starredList.appendChild(div);
            });
        }
        function closeStarredModalFunc() {
            starredModal.style.display = 'none';
        }
        function openCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification("Browser tidak mendukung kamera");
                return;
            }
            if (cameraActive) {
                closeCamera();
                return;
            }
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    cameraStream = stream;
                    cameraPreviewVideo.srcObject = stream;
                    cameraPreview.style.display = "block";
                    cameraActive = true;
                    cameraButton.innerHTML = '<i class="fas fa-camera-slash"></i>';
                })
                .catch(error => {
                    console.error("Error accessing camera:", error);
                    showNotification("Tidak dapat mengakses kamera: " + error.message);
                });
        }
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraPreview.style.display = "none";
            cameraActive = false;
            cameraButton.innerHTML = '<i class="fas fa-camera"></i>';
        }
        function startCall(type) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification("Browser tidak mendukung panggilan");
                return;
            }
            callType = type;
            callActive = true;
            callModal.classList.add('active');
            callTitle.textContent = type === 'video' ? 'Panggilan Video' : 'Panggilan Suara';
            callStatus.textContent = 'Mempersiapkan...';
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    videoDevices = devices.filter(device => device.kind === 'videoinput');
                    return navigator.mediaDevices.getUserMedia({
                        audio: true,
                        video: videoDevices.length > 0 ? { deviceId: videoDevices[0].deviceId } : true
                    });
                })
                .then(stream => {
                    localStream = stream;
                    if (type === 'video') {
                        localVideo.srcObject = stream;
                        localVideoPlaceholder.style.display = 'none';
                    } else {
                        localVideoPlaceholder.style.display = 'flex';
                    }
                    callStartTime = new Date();
                    callTimerInterval = setInterval(updateCallTimer, 1000);
                    callStatus.textContent = 'Memanggil...';
                    setTimeout(() => {
                        simulateCallAnswered();
                    }, 5000);
                })
                .catch(error => {
                    console.error("Error starting call:", error);
                    callStatus.textContent = 'Gagal memulai: ' + error.message;
                    endCall();
                });
        }
        function simulateCallAnswered() {
            callStatus.textContent = 'Terhubung';
            answerCallButton.style.display = 'none';
            remoteVideoPlaceholder.style.display = 'flex';
        }
        function answerCall() {
            callStatus.textContent = 'Terhubung';
            answerCallButton.style.display = 'none';
        }
        function endCall() {
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            callModal.classList.remove('active');
            minimizedCall.style.display = 'none';
            callActive = false;
            callType = null;
            callMinimized = false;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            minimizedRemoteVideo.srcObject = null;
            localVideoPlaceholder.style.display = 'flex';
            remoteVideoPlaceholder.style.display = 'flex';
            answerCallButton.style.display = 'block';
            callTimer.textContent = '00:00';
            currentZoom = 1;
        }
        function updateCallTimer() {
            const now = new Date();
            const diff = Math.floor((now - callStartTime) / 1000);
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            callTimer.textContent = `${minutes}:${seconds}`;
        }
        function toggleVideo() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoEnabled = !videoEnabled;
                videoTrack.enabled = videoEnabled;
                toggleVideoButton.innerHTML = videoEnabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                toggleVideoButton.style.backgroundColor = videoEnabled ? '#333' : '#e53935';
            }
        }
        function toggleAudio() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioEnabled = !audioEnabled;
                audioTrack.enabled = audioEnabled;
                toggleAudioButton.innerHTML = audioEnabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
                toggleAudioButton.style.backgroundColor = audioEnabled ? '#333' : '#e53935';
            }
        }
        function switchCamera() {
            if (!localStream || videoDevices.length < 2) return;
            currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
            const deviceId = videoDevices[currentDeviceIndex].deviceId;
            navigator.mediaDevices.getUserMedia({
                video: { deviceId: { exact: deviceId } },
                audio: true
            })
            .then(stream => {
                localStream.getTracks().forEach(track => track.stop());
                localStream = stream;
                localVideo.srcObject = stream;
            })
            .catch(error => {
                console.error("Error switching camera:", error);
            });
        }
        function minimizeCall() {
            callModal.classList.remove('active');
            minimizedCall.style.display = 'flex';
            callMinimized = true;
            if (remoteVideo.srcObject) {
                minimizedRemoteVideo.srcObject = remoteVideo.srcObject;
            }
        }
        function maximizeCall() {
            minimizedCall.style.display = 'none';
            callModal.classList.add('active');
            callMinimized = false;
            if (minimizedRemoteVideo.srcObject) {
                remoteVideo.srcObject = minimizedRemoteVideo.srcObject;
            }
        }
        function adjustZoom(delta) {
            currentZoom = Math.max(1, Math.min(3, currentZoom + delta));
            localVideo.style.transform = `scale(${currentZoom})`;
            remoteVideo.style.transform = `scale(${currentZoom})`;
        }
        function updateNetworkQuality() {
            if (!callActive) return;
            const quality = Math.random();
            let status, className;
            if (quality > 0.7) {
                status = 'Baik';
                className = 'good';
            } else if (quality > 0.4) {
                status = 'Sedang';
                className = 'average';
            } else {
                status = 'Buruk';
                className = 'poor';
            }
            networkIndicator.innerHTML = `<i class="fas fa-signal"></i> ${status}`;
            networkIndicator.className = `network-indicator ${className}`;
        }
        initApp();
    </script>
</body>
</html>
